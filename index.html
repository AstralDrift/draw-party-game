<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Draw Party! üé®</title>
    <meta name="description" content="The easiest multiplayer drawing game - just text a link and play!">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé®</text></svg>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS for P2P networking -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <!-- PWA manifest -->
    <link rel="manifest" href="/draw-party-game/manifest.json">
    <meta name="theme-color" content="#2c2a4a">
    
    <!-- iOS PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Draw Party">
    
    <style>
        :root {
            --font-display: 'Nunito', sans-serif;
            --font-body: 'Inter', sans-serif;
            --color-bg: #1a1836;
            --color-surface: #2c2a4a;
            --color-primary: #8a5cf6;
            --color-primary-hover: #7c3aed;
            --color-secondary: #34d399;
            --color-secondary-hover: #059669;
            --color-accent: #22d3ee;
            --color-text: #e5e7eb;
            --color-text-muted: #9ca3af;
            --color-border: #4b5563;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-display);
            font-weight: 800;
        }

        .btn {
            font-family: var(--font-display);
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }
        .btn-secondary {
            background-color: var(--color-secondary);
            color: white;
        }
        .btn-secondary:hover {
            background-color: var(--color-secondary-hover);
        }

        .input-field {
            background-color: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s;
            font-family: var(--font-body);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .card {
            background-color: var(--color-surface);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .canvas-container {
            touch-action: none;
            position: relative;
            width: 100%;
            max-width: min(90vw, 90vh, 500px);
            aspect-ratio: 4/3;
            margin: 0 auto;
        }
        
        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            border: 2px solid var(--color-border);
            border-radius: 0.75rem;
            background: white;
            cursor: crosshair;
            width: 100%;
            height: 100%;
            display: block;
        }

        #temp-canvas {
            background: transparent;
            pointer-events: none;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: all 0.3s ease;
            font-family: var(--font-display);
            font-weight: 700;
            border-radius: 0.5rem;
        }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .bounce { animation: bounce 0.6s ease-in-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }
        
        * { touch-action: manipulation; }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="min-h-screen flex flex-col p-4">
        <!-- Loading Screen -->
        <div id="loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="text-6xl mb-4">üé®</div>
                <h1 class="text-4xl mb-2">Draw Party!</h1>
                <div class="text-lg text-gray-400">Loading the fun...</div>
            </div>
        </div>
        
        <!-- Toast Container -->
        <div id="toast" class="toast hidden bg-green-500 text-white px-6 py-3 shadow-lg"></div>
        
        <!-- Main App Container -->
        <div id="game-container" class="hidden flex-1 flex flex-col items-center justify-center max-w-4xl w-full mx-auto">
            
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="text-center w-full max-w-md">
                <div class="text-8xl mb-6">üé®</div>
                <h1 class="text-5xl mb-4">Welcome to Draw Party!</h1>
                <p class="text-xl text-gray-400 mb-10">The easiest multiplayer drawing game ever.</p>
                
                <div class="space-y-4">
                    <button id="create-room" class="w-full btn btn-primary text-xl">
                        üéÆ Create New Game
                    </button>
                    <div class="text-gray-500 font-bold">OR</div>
                    <div class="flex gap-3">
                        <input id="join-code" type="text" placeholder="ENTER CODE" 
                               class="flex-1 input-field text-center uppercase tracking-widest font-bold text-lg" 
                               maxlength="4">
                        <button id="join-room" class="btn btn-secondary">
                            Join
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Lobby Screen -->
            <div id="lobby-screen" class="hidden w-full max-w-md">
                <div class="text-center mb-8">
                    <h2 class="text-4xl mb-4">Game Lobby</h2>
                    <div class="card mb-6">
                        <div class="text-lg text-gray-400">Room Code</div>
                        <div id="current-room-code" class="text-5xl font-mono font-bold text-white tracking-widest"></div>
                    </div>
                    
                    <button id="share-game" class="w-full btn btn-primary">
                        üì± Share Game Link
                    </button>
                </div>
                
                <div class="card mb-6">
                    <h3 class="text-2xl font-bold mb-4 text-center">Players</h3>
                    <div id="players-list" class="space-y-3"></div>
                    <div id="waiting-message" class="text-gray-400 text-center mt-4">
                        Waiting for more players... (need at least 2)
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <input id="player-name" type="text" placeholder="Enter your name" 
                               class="flex-1 input-field">
                        <button id="submit-name" class="btn btn-primary">
                            Set
                        </button>
                    </div>
                    <button id="start-game" class="w-full btn btn-secondary text-xl" disabled>
                        üé® Start Drawing!
                    </button>
                </div>
            </div>
            
            <!-- Drawing Screen -->
            <div id="drawing-screen" class="hidden w-full">
                <div class="text-center mb-4">
                    <div id="drawing-prompt" class="text-2xl font-bold mb-2 card inline-block"></div>
                    <div id="drawing-timer" class="text-4xl font-mono text-accent"></div>
                </div>
                
                <div class="canvas-container mx-auto mb-4" id="canvas-container">
                    <canvas id="drawing-canvas" class="drawing-canvas"></canvas>
                    <canvas id="temp-canvas" class="drawing-canvas"></canvas>
                </div>
                
                <div class="flex flex-wrap gap-4 justify-center items-center mb-4" id="drawing-tools">
                    <div class="flex gap-2 card p-2" id="color-palette">
                        <!-- Player colors will be populated here -->
                    </div>
                    
                    <div class="flex gap-2 card p-2" id="tool-palette">
                        <button id="undo-btn" class="tool-btn btn">‚Ü©Ô∏è</button>
                        <button id="redo-btn" class="tool-btn btn">‚Ü™Ô∏è</button>
                        <button id="brush-btn" class="tool-btn btn btn-primary">üñåÔ∏è</button>
                        <button id="line-btn" class="tool-btn btn">‚Äî</button>
                        <button id="arrow-btn" class="tool-btn btn">‚Üí</button>
                        <button id="rect-btn" class="tool-btn btn">‚ñ≠</button>
                        <button id="circle-btn" class="tool-btn btn">‚ö™</button>
                        <button id="eraser" class="tool-btn btn">üóëÔ∏è</button>
                        <button id="clear-canvas" class="tool-btn btn bg-red-600 hover:bg-red-700">‚úñÔ∏è</button>
                    </div>
                </div>
                
                <div class="text-center">
                    <div class="text-sm text-gray-400 mb-2">‚ö†Ô∏è No letters or words allowed!</div>
                    <div id="other-players-status" class="text-gray-400"></div>
                </div>
            </div>
            
            <!-- ... (rest of the HTML is the same) ... -->
            
        </div>
    </div>

    <script>
        const DEBUG_MODE = false; // Set to true for development logging
        const debugLog = (...args) => {
            if (DEBUG_MODE) {
                console.log(...args);
            }
        };

        class DrawingHistory { 
            /* ... (same as before) ... */
        }

        // Game Core - All functionality embedded
        class DrawPartyGame {
            constructor() {
                // ... (same as before) ...
                this.currentTool = 'brush';
                this.drawingHistory = new DrawingHistory();
                this.shapeStartPos = null;
                // ... (rest of constructor is the same) ...
            }
            
            init() {
                // ... (same as before) ...
                this.setupShapeTools();
            }

            // ... (most methods are the same) ...

            setupEventListeners() {
                // ... (same as before) ...
                document.getElementById('brush-btn').addEventListener('click', () => this.selectTool('brush'));
                document.getElementById('line-btn').addEventListener('click', () => this.selectTool('line'));
                document.getElementById('arrow-btn').addEventListener('click', () => this.selectTool('arrow'));
                document.getElementById('rect-btn').addEventListener('click', () => this.selectTool('rect'));
                document.getElementById('circle-btn').addEventListener('click', () => this.selectTool('circle'));
                document.getElementById('eraser').addEventListener('click', () => this.selectTool('eraser'));
                // ... (rest of event listeners are the same) ...
            }

            selectTool(tool) {
                this.currentTool = tool;
                this.updateToolButtons();
            }

            updateToolButtons() {
                document.querySelectorAll('#tool-palette .tool-btn').forEach(btn => btn.classList.remove('btn-primary'));
                document.getElementById(`${this.currentTool}-btn`)?.classList.add('btn-primary');
            }

            setupCanvas() {
                const canvas = document.getElementById('drawing-canvas');
                const tempCanvas = document.getElementById('temp-canvas');
                const ctx = canvas.getContext('2d');
                const tempCtx = tempCanvas.getContext('2d');

                const resize = () => {
                    const container = canvas.parentElement;
                    const dpr = window.devicePixelRatio || 1;
                    canvas.width = tempCanvas.width = container.clientWidth * dpr;
                    canvas.height = tempCanvas.height = container.clientHeight * dpr;
                    ctx.scale(dpr, dpr);
                    tempCtx.scale(dpr, dpr);
                    this.clearCanvas(false);
                };
                window.addEventListener('resize', resize);
                resize();

                const getPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { x: clientX - rect.left, y: clientY - rect.top };
                };

                const start = (e) => {
                    if (this.gameState.phase !== 'DRAWING') return;
                    e.preventDefault();
                    this.isDrawing = true;
                    this.shapeStartPos = getPos(e);
                    this.lastPos = this.shapeStartPos;
                };

                const draw = (e) => {
                    if (!this.isDrawing) return;
                    e.preventDefault();
                    const pos = getPos(e);
                    if (this.currentTool === 'brush' || this.currentTool === 'eraser') {
                        this.drawBrush(ctx, this.lastPos, pos);
                        this.lastPos = pos;
                    } else {
                        tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                        this.drawShape(tempCtx, this.shapeStartPos, pos);
                    }
                };

                const stop = () => {
                    if (!this.isDrawing) return;
                    this.isDrawing = false;
                    if (this.currentTool !== 'brush' && this.currentTool !== 'eraser') {
                        this.drawShape(ctx, this.shapeStartPos, this.lastPos);
                        tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                    }
                    this.drawingHistory.saveState(canvas);
                }

                tempCanvas.addEventListener('mousedown', start);
                tempCanvas.addEventListener('mousemove', draw);
                tempCanvas.addEventListener('mouseup', stop);
                tempCanvas.addEventListener('mouseout', stop);
                tempCanvas.addEventListener('touchstart', start, { passive: false });
                tempCanvas.addEventListener('touchmove', draw, { passive: false });
                tempCanvas.addEventListener('touchend', stop);
            }

            drawBrush(ctx, start, end) {
                ctx.beginPath();
                ctx.moveTo(start.x, start.y);
                ctx.lineTo(end.x, end.y);
                ctx.strokeStyle = this.currentTool === 'eraser' ? 'white' : this.currentColor;
                ctx.lineWidth = this.currentSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            }

            drawShape(ctx, start, end) {
                ctx.strokeStyle = this.currentColor;
                ctx.lineWidth = this.currentSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                if (this.currentTool === 'rect') {
                    ctx.strokeRect(start.x, start.y, end.x - start.x, end.y - start.y);
                } else if (this.currentTool === 'circle') {
                    const radius = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                    ctx.beginPath();
                    ctx.arc(start.x, start.y, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                } else if (this.currentTool === 'line') {
                    ctx.beginPath();
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    ctx.stroke();
                } else if (this.currentTool === 'arrow') {
                    this.drawArrow(ctx, start, end);
                }
            }

            drawArrow(ctx, start, end) {
                const headlen = 10;
                const angle = Math.atan2(end.y - start.y, end.x - start.x);
                ctx.beginPath();
                ctx.moveTo(start.x, start.y);
                ctx.lineTo(end.x, end.y);
                ctx.lineTo(end.x - headlen * Math.cos(angle - Math.PI / 6), end.y - headlen * Math.sin(angle - Math.PI / 6));
                ctx.moveTo(end.x, end.y);
                ctx.lineTo(end.x - headlen * Math.cos(angle + Math.PI / 6), end.y - headlen * Math.sin(angle + Math.PI / 6));
                ctx.stroke();
            }

            // ... (rest of the file is the same) ...
        }

        window.game = new DrawPartyGame();
    </script>
</body>
</html>
